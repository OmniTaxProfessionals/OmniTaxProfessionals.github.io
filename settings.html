<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Security Settings</title>
  <style>
    body { font-family: sans-serif; padding: 40px; background-color: #121212; color: white; text-align: center; }
    .card { background: #1e1e1e; padding: 30px; border-radius: 10px; max-width: 400px; margin: auto; border: 1px solid #333; }
    input { padding: 10px; width: 80%; margin: 10px 0; background: #222; color: white; border: 1px solid #444; border-radius: 5px; }
    button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:disabled { background: #555; cursor: not-allowed; }
    .status { margin-top: 20px; font-size: 14px; color: #aaa; }
    .warning { color: #ffc107; font-size: 13px; margin-bottom: 15px; display: none; }
    .back-link { display: block; margin-top: 20px; color: #39a86a; text-decoration: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Two-Factor Auth</h2>
    
    <div id="emailWarning" class="warning">
      ⚠️ You must verify your email before enabling 2FA. 
      <br><button id="resendEmailBtn" style="background:none; color:#39a86a; text-decoration:underline; border:none; padding:5px; font-size:12px;">Resend Verification Email</button>
    </div>

    <div id="mfaEnrollmentUI">
      <input type="text" id="phoneNumber" placeholder="+1 555 000 0000">
      <button id="sendCodeBtn">Enable 2FA</button>
      <div id="recaptcha-container"></div>
    </div>

    <div id="mfaStatus" class="status">Checking status...</div>
    <a href="dashboard.html" class="back-link">← Back to Dashboard</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, multiFactor, PhoneAuthProvider, PhoneMultiFactorGenerator, RecaptchaVerifier, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 1. IMPORT YOUR CONFIG
    import firebaseConfig from './config.js';

    // 2. INITIALIZE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href = "index.html"; return; }

      const isVerified = user.emailVerified;
      const factors = multiFactor(user).enrolledFactors;

      if (!isVerified) {
        document.getElementById("emailWarning").style.display = "block";
        document.getElementById("phoneNumber").disabled = true;
        document.getElementById("sendCodeBtn").disabled = true;
        document.getElementById("mfaStatus").textContent = "Email verification required.";
      } else {
        document.getElementById("mfaStatus").textContent = factors.length > 0 ? "✅ 2FA is currently ENABLED" : "❌ 2FA is currently DISABLED";
      }
    });

    document.getElementById("resendEmailBtn").addEventListener("click", async () => {
      try {
        await sendEmailVerification(auth.currentUser);
        alert("Verification email sent! Please check your inbox and refresh this page.");
      } catch (e) {
        alert(e.message);
      }
    });

    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'sendCodeBtn', { 'size': 'invisible' });

    document.getElementById("sendCodeBtn").addEventListener("click", async () => {
      const phone = document.getElementById("phoneNumber").value;
      if (!phone) return alert("Enter phone number with country code (e.g. +1)");

      try {
        const session = await multiFactor(auth.currentUser).getSession();
        const phoneAuthProvider = new PhoneAuthProvider(auth);
        const vId = await phoneAuthProvider.verifyPhoneNumber({ phoneNumber: phone, session: session }, window.recaptchaVerifier);
        
        const code = prompt("Enter the 6-digit code sent to " + phone);
        if (code) {
          const cred = PhoneAuthProvider.credential(vId, code);
          const assertion = PhoneMultiFactorGenerator.assertion(cred);
          await multiFactor(auth.currentUser).enroll(assertion, "Primary Phone");
          alert("Success! 2FA is now active.");
          location.reload();
        }
      } catch (e) {
        alert("Error: " + e.message);
      }
    });
  </script>
</body>
</html>